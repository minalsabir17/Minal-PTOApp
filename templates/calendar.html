{% extends "base.html" %}

{% block title %}Calendar - MSW CVI PTO Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-calendar me-2"></i>PTO Calendar
            <small class="text-muted">- Real-time Schedule View</small>
        </h2>
    </div>
</div>

<!-- Filters and Legend -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-filter me-2"></i>Filters
                </h6>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="teamFilter" class="form-label">Filter by Team:</label>
                        <select id="teamFilter" class="form-select">
                            <option value="">All Teams</option>
                            <option value="admin">Admin</option>
                            <option value="clinical">Clinical</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="positionFilter" class="form-label">Filter by Position:</label>
                        <select id="positionFilter" class="form-select">
                            <option value="">All Positions</option>
                            <option value="APP">APP</option>
                            <option value="CVI RNs">CVI RNs</option>
                            <option value="CVI MOAs">CVI MOAs</option>
                            <option value="CVI Echo Techs">CVI Echo Techs</option>
                            <option value="Front Desk/Admin">Front Desk/Admin</option>
                            <option value="CT Desk">CT Desk</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-secondary" id="clearFilters">
                            <i class="fas fa-times me-1"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>Legend
                </h6>
                <div class="d-flex flex-wrap gap-3">
                    <div class="d-flex align-items-center">
                        <div class="legend-color bg-success me-2"></div>
                        <span>Approved</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="legend-color bg-warning me-2"></div>
                        <span>Pending</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="legend-color bg-danger me-2"></div>
                        <span>Call Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Calendar View -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-calendar-check me-2"></i>PTO Schedule Calendar
        </h5>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" id="prevMonth">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="today">Today</button>
            <button type="button" class="btn btn-outline-primary btn-sm" id="nextMonth">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">PTO Request Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
                <!-- Event details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick View Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-list me-2"></i>Upcoming PTO (Next 7 Days)
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="upcomingEvents">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
<style>
.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
    display: inline-block;
}

.fc-event {
    cursor: pointer;
}

.fc-event:hover {
    opacity: 0.8;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

/* Custom calendar styling */
.fc-toolbar-title {
    color: var(--sinai-primary);
    font-weight: bold;
}

.fc-button-primary {
    background-color: var(--sinai-primary);
    border-color: var(--sinai-primary);
}

.fc-button-primary:hover {
    background-color: var(--sinai-secondary);
    border-color: var(--sinai-secondary);
}

.fc-daygrid-event {
    border-radius: 3px;
    padding: 2px;
}

/* Status-specific styling */
.status-approved {
    background-color: #28a745;
    border-color: #28a745;
}

.status-pending {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.status-callout {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
}


.upcoming-event {
    border-left: 4px solid;
    margin-bottom: 10px;
    padding-left: 15px;
}

.upcoming-event.approved {
    border-left-color: #28a745;
}

.upcoming-event.pending {
    border-left-color: #ffc107;
}

.upcoming-event.callout {
    border-left-color: #dc3545;
}

</style>
{% endblock %}

{% block extra_scripts %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    // Calendar events data from Flask
    const allEvents = {{ calendar_events|tojson|safe }};
    let filteredEvents = [...allEvents]; // Start with all events
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        events: filteredEvents,
        headerToolbar: {
            left: 'title',
            center: '',
            right: ''
        }, // Show month/year title
        
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        
        eventMouseEnter: function(info) {
            info.el.style.opacity = '0.8';
        },
        
        eventMouseLeave: function(info) {
            info.el.style.opacity = '1';
        },
        
        dayMaxEvents: 3, // Show "more" link when too many events
        
        eventDidMount: function(info) {
            // Add custom styling based on call-out or status
            const isCallOut = info.event.extendedProps.is_call_out;
            const status = info.event.extendedProps.status;

            if (isCallOut) {
                info.el.classList.add('status-callout');
            } else {
                info.el.classList.add(`status-${status}`);
            }

            // Add tooltip
            const tooltipText = isCallOut
                ? `Call Out - ${info.event.extendedProps.employee}\n` +
                  `Type: ${info.event.extendedProps.type}\n` +
                  `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}\n` +
                  `Duration: ${info.event.extendedProps.duration}`
                : `${info.event.extendedProps.employee}\n` +
                  `Type: ${info.event.extendedProps.type}\n` +
                  `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}\n` +
                  `Duration: ${info.event.extendedProps.duration}`;

            info.el.setAttribute('title', tooltipText);
        }
    });
    
    calendar.render();
    
    // Custom navigation buttons
    document.getElementById('prevMonth').addEventListener('click', function() {
        calendar.prev();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        calendar.next();
    });
    
    document.getElementById('today').addEventListener('click', function() {
        calendar.today();
    });
    
    // Show event details in modal
    function showEventDetails(event) {
        const props = event.extendedProps;
        const startDate = new Date(event.start);
        const endDate = event.end ? new Date(event.end) : startDate;

        // Determine status badge class
        const statusBadgeClass = props.is_call_out ? 'status-callout' : `status-${props.status}`;

        const detailsHtml = `
            ${props.is_call_out ? `
            <div class="alert alert-danger mb-3">
                <strong><i class="fas fa-exclamation-circle me-2"></i>Call Out Request</strong>
            </div>
            ` : ''}
            <div class="row">
                <div class="col-sm-4"><strong>Employee:</strong></div>
                <div class="col-sm-8">${props.employee}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Type:</strong></div>
                <div class="col-sm-8">${props.type}${props.is_call_out ? ' (Call Out)' : ''}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Status:</strong></div>
                <div class="col-sm-8">
                    <span class="badge ${statusBadgeClass}">${props.status.charAt(0).toUpperCase() + props.status.slice(1)}</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Team:</strong></div>
                <div class="col-sm-8">${props.team.charAt(0).toUpperCase() + props.team.slice(1)}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Dates:</strong></div>
                <div class="col-sm-8">${startDate.toLocaleDateString()} ${endDate.getTime() !== startDate.getTime() ? 'to ' + endDate.toLocaleDateString() : ''}</div>
            </div>
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Duration:</strong></div>
                <div class="col-sm-8">${props.duration}${props.is_partial_day ? '' : ' days'}</div>
            </div>
            ${props.reason ? `
            <div class="row mt-2">
                <div class="col-sm-4"><strong>Reason:</strong></div>
                <div class="col-sm-8">${props.reason}</div>
            </div>
            ` : ''}
        `;

        document.getElementById('eventDetails').innerHTML = detailsHtml;
        eventModal.show();
    }
    
    // Populate upcoming events
    function populateUpcomingEvents() {
        const now = new Date();
        const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
        
        const upcomingEvents = filteredEvents.filter(event => {
            const eventDate = new Date(event.start);
            return eventDate >= now && eventDate <= nextWeek;
        }).sort((a, b) => new Date(a.start) - new Date(b.start));
        
        const upcomingContainer = document.getElementById('upcomingEvents');
        
        if (upcomingEvents.length === 0) {
            upcomingContainer.innerHTML = `
                <div class="col-12">
                    <p class="text-muted text-center">No upcoming PTO in the next 7 days</p>
                </div>
            `;
            return;
        }
        
        upcomingContainer.innerHTML = upcomingEvents.map(event => {
            const startDate = new Date(event.start);
            const isCallOut = event.extendedProps.is_call_out;
            const statusClass = isCallOut ? 'callout' : event.extendedProps.status;
            const badgeClass = isCallOut ? 'status-callout' : `status-${event.extendedProps.status}`;
            const title = isCallOut ? `Call Out - ${event.extendedProps.employee}` : event.extendedProps.employee;

            return `
                <div class="col-md-6 mb-3">
                    <div class="upcoming-event ${statusClass}">
                        <strong>${title}</strong><br>
                        <small class="text-muted">${event.extendedProps.type}${isCallOut ? ' (Call Out)' : ''}</small><br>
                        <small>${startDate.toLocaleDateString()} â€¢ ${event.extendedProps.duration}${event.extendedProps.is_partial_day ? '' : ' days'}</small><br>
                        <span class="badge ${badgeClass} mt-1">${event.extendedProps.status.charAt(0).toUpperCase() + event.extendedProps.status.slice(1)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    populateUpcomingEvents();
    
    // Filter functionality
    function applyFilters() {
        const teamFilter = document.getElementById('teamFilter').value;
        const positionFilter = document.getElementById('positionFilter').value;
        
        filteredEvents = allEvents.filter(event => {
            const teamMatch = !teamFilter || event.extendedProps.team === teamFilter;
            const positionMatch = !positionFilter || event.extendedProps.employee_position === positionFilter;
            return teamMatch && positionMatch;
        });
        
        // Remove all events and add filtered ones
        calendar.removeAllEvents();
        calendar.addEventSource(filteredEvents);
        
        // Update upcoming events panel
        populateUpcomingEvents();
    }
    
    // Filter event listeners
    document.getElementById('teamFilter').addEventListener('change', applyFilters);
    document.getElementById('positionFilter').addEventListener('change', applyFilters);
    
    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('teamFilter').value = '';
        document.getElementById('positionFilter').value = '';
        applyFilters();
    });
});
</script>
{% endblock %}